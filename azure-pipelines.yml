trigger:
  - main

pool:
  name: 'Default' # Replace with your custom pool if needed
  demands:
    - agent.name -equals viroc-agent1

variables:
  buildConfiguration: 'production'
  buildDirectory: '$(Build.ArtifactStagingDirectory)/dist'

steps:
# Step 1: List all files (for debugging)
- script: dir /s
  displayName: 'List all files'

# Step 2: Clean node_modules (Prevent Infinite Nesting)
- script: |
    if exist node_modules ( rmdir /s /q node_modules )
  displayName: 'Clean node_modules (Fix Tar Error)'

# Step 3: Use Cached Node Modules (Speeds up Build)
- task: Cache@2
  inputs:
    key: 'npm | "$(Agent.OS)" | package-lock.json'
    path: 'node_modules'
    cacheHitVar: 'CACHE_RESTORED'
  displayName: 'Cache Node Modules'

# Step 4: Install Node.js (Only Needed Once)
- task: UseNode@1
  inputs:
    version: '18.x' # Ensure compatibility with your Angular project

# Step 5: Install Dependencies (Skip if Cached)
- script: |
    if not defined CACHE_RESTORED (
      echo "Cache not found, running npm ci"
      npm ci
    ) else (
      echo "Using cached node_modules"
    )
  displayName: 'Install Dependencies'

# Step 6: Build Angular Application
- script: ng build --configuration=$(buildConfiguration) --output-path=$(buildDirectory)
  displayName: 'Build Angular Application'

# Step 7: Archive Build Output into ZIP
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(buildDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/angular-app.zip'
    replaceExistingArchive: true
  displayName: 'Create ZIP package'

# Step 8: Publish Build Artifacts (ZIP)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/angular-app.zip'
    ArtifactName: 'drop'
    publishLocation: 'Container'
  displayName: 'Publish Angular Build ZIP'
