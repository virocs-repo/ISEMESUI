<div class="k-d-flex k-align-items-center k-gap-4 k-py-2 k-px-4 page-header">
  <kendo-label text="Search All Columns" class="k-font-size-sm k-d-flex k-align-items-center">
    <input kendoTextBox [(ngModel)]="searchText" (ngModelChange)="onSearchTextChange()" type="text"
      placeholder="Type to search across all columns..." style="width: 300px;" />
  </kendo-label>
  <kendo-label text="Active" class="k-font-size-sm k-d-flex k-align-items-center">
    <kendo-checkbox [(ngModel)]="selectedActive" (ngModelChange)="loadGridData()" class="k-ml-2"></kendo-checkbox>
  </kendo-label>
  <div class="k-ml-auto k-d-flex k-gap-2">
    <button kendoButton rounded="full" themeColor="info" (click)="openAddDialog()">Add</button>
    <button kendoButton rounded="full" (click)="onClear()">Clear</button>
  </div>
</div>
<div class="k-m-4">
  <kendo-grid
    [kendoGridBinding]="gridDataResult.data"
    [selectable]="selectableSettings"
    [columnMenu]="columnMenuSettings"
    [filterable]="true"
    [sortable]="true"
    [resizable]="true"
    [pageSize]="pageSize"
    [skip]="skip"
    [pageable]="{
      buttonCount: 5,
      info: true,
      type: 'numeric',
      pageSizes: [25, 50, 100],
      previousNext: true
    }"
    (pageChange)="pageChange($event)"
    (cellClick)="onCellClick($event)"
    class="inventory-grid"
    [rowClass]="rowCallback">
    <kendo-grid-column title="Actions" [width]="120" [locked]="false">
      <ng-template kendoGridCellTemplate let-dataItem>
        <div class="k-d-flex k-gap-2">
          <button kendoButton size="small" themeColor="primary" [svgIcon]="ICON.pencilIcon" 
            (click)="onEdit(dataItem)" title="Edit"></button>
          <button kendoButton size="small" themeColor="info" [svgIcon]="ICON.eyeIcon" 
            (click)="onView(dataItem)" title="View"></button>
        </div>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column *ngFor="let c of columnData" [field]="c.field" [title]="c.title" [width]="c.width">
      <ng-template kendoGridCellTemplate let-dataItem>
        <span class="truncate-text" [title]="dataItem?.[c.field] || ''">
          {{ dataItem?.[c.field] || '' }}
        </span>
      </ng-template>
    </kendo-grid-column>
  </kendo-grid>
</div>

<!-- Add/Edit Dialog -->
<kendo-dialog
  *ngIf="isDialogOpen"
  (close)="closeDialog()"
  [minWidth]="1400"
  [width]="'95%'"
  [height]="'95%'"
  class="dialog-round">
  <div class="k-d-flex k-align-items-center k-mb-2">
    <h2 class="k-m-0 k-font-size-lg">{{ isViewMode ? 'View Device' : (isEditMode ? 'Edit Device' : 'Add Device') }}</h2>
    <button kendoButton type="button" rounded="full" class="k-ml-auto" [svgIcon]="ICON.xIcon" size="small"
      (click)="closeDialog()"></button>
  </div>
  <div class="k-d-flex k-flex-column k-gap-2 k-p-2 dialog-scrollable-content" style="max-height: calc(95vh - 120px); overflow-y: auto;">
    
    <!-- Device Info Section -->
    <div class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">Device Info</h3>
      <div class="k-d-grid k-grid-cols-3 k-gap-2">
        <kendo-label text="Customer *" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getCustomerName(deviceData.customerID)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="customersList"
            [valuePrimitive]="true"
            [textField]="'CustomerName'"
            [valueField]="'CustomerID'"
            [(ngModel)]="deviceData.customerID"
            (valueChange)="onDialogCustomerChange($event)"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [disabled]="isEditMode"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Device Family *" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDeviceFamilyName(deviceData.deviceFamilyId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="deviceFamilies"
            [valuePrimitive]="true"
            [textField]="'deviceFamilyName'"
            [valueField]="'deviceFamilyId'"
            [(ngModel)]="deviceData.deviceFamilyId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [disabled]="!deviceData.customerID || deviceData.customerID === -1 || !canEdit"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Test Device *" class="k-font-size-sm">
          <input kendoTextBox [(ngModel)]="deviceData.testDevice" type="text"
            (ngModelChange)="onTestDeviceChange($event)"
            placeholder="Enter Test Device" class="w-100" [readonly]="isViewMode || !canEdit || !deviceEditEnabled" />
        </kendo-label>
        
        <kendo-label text="Reliability Device *" class="k-font-size-sm">
          <input kendoTextBox [(ngModel)]="deviceData.reliabilityDevice" type="text"
            placeholder="Enter Reliability Device" class="w-100" [readonly]="isViewMode || !canEdit || !deviceEditEnabled" />
        </kendo-label>
        
        <kendo-label text="Alias Names" class="k-font-size-sm" style="grid-column: span 2;">
          <div class="k-d-flex k-gap-2">
            <input kendoTextBox [(ngModel)]="deviceData.newAliasName" type="text"
              placeholder="Enter Alias Name" class="k-flex-1" [readonly]="isViewMode || !deviceEditEnabled" />
            <button kendoButton themeColor="primary" size="small" (click)="addAliasName()" [disabled]="isViewMode || !deviceData.newAliasName || !deviceEditEnabled">Add</button>
          </div>
          <div class="k-d-flex k-flex-wrap k-gap-1 k-mt-1" *ngIf="deviceData.aliasNames && deviceData.aliasNames.length > 0">
            <span *ngFor="let alias of deviceData.aliasNames" class="k-badge k-badge-primary k-d-flex k-align-items-center k-gap-1" style="font-size: 0.75rem;">
              {{alias}}
              <button kendoButton *ngIf="!isViewMode" size="small" [svgIcon]="ICON.xIcon" 
                (click)="removeAliasName(alias)" class="k-p-0" style="min-width: auto; padding: 0 2px;"></button>
            </span>
          </div>
        </kendo-label>
        
        <kendo-label text="SKU" class="k-font-size-sm">
          <input kendoTextBox [(ngModel)]="deviceData.sku" type="text"
            placeholder="Enter SKU" class="w-100" [readonly]="isViewMode || !deviceEditEnabled" />
        </kendo-label>
        
        <kendo-label text="Part Type" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="deviceData.partType" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="partTypes"
            [valuePrimitive]="true"
            [valueField]="'value'"
            [textField]="'text'"
            [(ngModel)]="deviceData.partType"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Lot Type *" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="deviceData.lotType" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="lotTypes"
            [valuePrimitive]="true"
            [valueField]="'value'"
            [textField]="'text'"
            [(ngModel)]="deviceData.lotType"
            [disabled]="!canEditlotType"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <div class="k-font-size-sm k-d-flex k-align-items-center k-gap-1" style="padding-top: 1.5rem;">
          <kendo-checkbox [(ngModel)]="deviceData.labelMapping" [disabled]="isViewMode || !labelEditEnabled" (ngModelChange)="onLabelMappingChange()"></kendo-checkbox>
          <span>Label Mapping</span>
        </div>
        
        <div class="k-font-size-sm k-d-flex k-align-items-center k-gap-1" style="padding-top: 1.5rem;">
          <kendo-checkbox [(ngModel)]="deviceData.isActive" [disabled]="isViewMode || !isEditMode || !canEdit || !deviceEditEnabled"></kendo-checkbox>
          <span>Active</span>
        </div>
        
        <kendo-label text="Tray/Tube Mapping" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="deviceData.trayTubeMapping" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="[{value: 'Lot', text: 'Lot'}, {value: 'Device', text: 'Device'}]"
            [valuePrimitive]="true"
            [valueField]="'value'"
            [textField]="'text'"
            [(ngModel)]="deviceData.trayTubeMapping"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Country of Origin (COO)" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(countriesOfOrigin, deviceData.countryOfOriginId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="countriesOfOrigin"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.countryOfOriginId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Unit Cost" class="k-font-size-sm">
          <input kendoTextBox [(ngModel)]="deviceData.unitCost" type="number" step="0.01"
            placeholder="0" class="w-100" [readonly]="isViewMode || !deviceEditEnabled" 
            (ngModelChange)="onUnitCostChange($event)" />
        </kendo-label>
      </div>
    </div>
    
    <!-- Label Info Section -->
    <div class="k-border k-border-solid k-border-gray-300 k-p-2 k-rounded" *ngIf="deviceData.labelMapping">
      <h3 class="k-mt-0 k-mb-1 k-text-primary k-font-size-sm k-font-weight-bold">Label Info</h3>
      <div class="k-d-grid k-grid-cols-3 k-gap-2">
        <!-- Dynamic Labels -->
        <ng-container *ngFor="let labelNum of activeLabels; trackBy: trackByLabelNumber; let i = index">
          <kendo-label [text]="'Label' + labelNum" class="k-font-size-sm">
            <div *ngIf="isViewMode" class="k-d-flex k-align-items-center k-gap-2">
              <input kendoTextBox [value]="getLabelDisplayText(getLabelValue(labelNum))" type="text"
                class="k-flex-1" readonly />
              <button kendoButton size="small" (click)="openLabelDetails(labelNum)" [disabled]="!isLabelSelected(labelNum)">--</button>
            </div>
            <div *ngIf="!isViewMode" class="k-d-flex k-align-items-center k-gap-2">
              <!-- Use refresh counter in ID to force re-render when value changes -->
              <kendo-dropdownlist
                [id]="'label-dropdown-' + labelNum + '-' + i + '-' + labelRefreshCounter"
                [data]="customerLabels"
                [valuePrimitive]="true"
                [textField]="'name'"
                [valueField]="'id'"
                [value]="getLabelValue(labelNum)"
                (valueChange)="onLabelValueChange(labelNum, $event)"
                (selectionChange)="onLabelSelectionChange(labelNum, $event)"
                [disabled]="!getCanEditLabel(labelNum) || !labelEditEnabled"
                [filterable]="true"
                [kendoDropDownFilter]="filterSettings"
                class="k-flex-1">
              </kendo-dropdownlist>
              <button kendoButton size="small" (click)="openLabelDetails(labelNum)" [disabled]="!isLabelSelected(labelNum) || !labelEditEnabled">--</button>
              <button kendoButton size="small" themeColor="error" [svgIcon]="ICON.xIcon" 
                (click)="removeLabel(labelNum)" title="Remove Label" 
                [disabled]="!labelEditEnabled"></button>
            </div>
          </kendo-label>
        </ng-container>
        
        <!-- Add Label Button -->
        <div *ngIf="!isViewMode && activeLabels.length < 5" class="k-d-flex k-align-items-end">
          <button kendoButton themeColor="primary" size="small" (click)="addLabel()" 
            [disabled]="!labelEditEnabled || activeLabels.length >= 5">
            + Add Label
          </button>
        </div>
      </div>
    </div>
    
    <!-- EAR Info Section -->
    <div class="k-border k-border-solid k-border-gray-300 k-p-2 k-rounded">
      <h3 class="k-mt-0 k-mb-1 k-text-primary k-font-size-sm k-font-weight-bold">EAR Info</h3>
      <div class="k-d-grid k-grid-cols-3 k-gap-2">
        <kendo-label text="Material Description" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(materialDescriptions, deviceData.materialDescriptionId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="materialDescriptions"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.materialDescriptionId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="US HTS Code" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(usHtsCodes, deviceData.usHtsCodeId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="usHtsCodes"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.usHtsCodeId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="ECCN" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(eccns, deviceData.eccnId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="eccns"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.eccnId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="License Exceptions" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(licenseExceptions, deviceData.licenseExceptionId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="licenseExceptions"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.licenseExceptionId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Restricted Countries to Ship" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getRestrictedCountriesDisplayText()" type="text"
            class="w-100" readonly />
          <kendo-multiselect
            *ngIf="!isViewMode"
            [data]="restrictedCountries"
            [(ngModel)]="deviceData.restrictedCountriesToShipIds"
            [textField]="'name'"
            [valueField]="'id'"
            [valuePrimitive]="true"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            placeholder="--Select--"
            class="w-100">
            <ng-template kendoMultiSelectHeaderTemplate>
              <div class="k-d-flex k-align-items-center k-p-2" style="border-bottom: 1px solid #e0e0e0;">
                <input type="checkbox" 
                  [checked]="isAllRestrictedCountriesSelected()" 
                  (change)="toggleSelectAllRestrictedCountries($event)"
                  #selectAllCheckbox
                  style="margin-right: 8px; cursor: pointer;">
                <label style="font-weight: 500; cursor: pointer; margin: 0; user-select: none;" 
                       (click)="selectAllCheckbox.click()">
                  Select All
                </label>
              </div>
            </ng-template>
          </kendo-multiselect>
        </kendo-label>
        
        <div class="k-font-size-sm k-d-flex k-align-items-center k-gap-1" style="padding-top: 1.5rem;">
          <kendo-checkbox [(ngModel)]="deviceData.scheduleB" [disabled]="isViewMode"></kendo-checkbox>
          <span>Schedule B</span>
        </div>
      </div>
    </div>
    
    <!-- Pack&Label Info Section -->
    <div class="k-border k-border-solid k-border-gray-300 k-p-2 k-rounded">
      <h3 class="k-mt-0 k-mb-1 k-text-primary k-font-size-sm k-font-weight-bold">Pack&Label Info</h3>
      <div class="k-d-grid k-grid-cols-3 k-gap-2">
        <kendo-label text="MSL" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(msls, deviceData.mslId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="msls"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.mslId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Peak Package Body Temperature" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(peakPackageBodyTemperatures, deviceData.peakPackageBodyTemperatureId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="peakPackageBodyTemperatures"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.peakPackageBodyTemperatureId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Shelf Life (Month)" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(shelfLifeMonths, deviceData.shelfLifeMonthId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="shelfLifeMonths"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.shelfLifeMonthId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Floor Life" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(floorLives, deviceData.floorLifeId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="floorLives"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.floorLifeId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="PB Free" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(pbFrees, deviceData.pbFreeId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="pbFrees"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.pbFreeId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="PB Free Sticker" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(pbFreeStickers, deviceData.pbFreeStickerId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="pbFreeStickers"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.pbFreeStickerId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="ROHS" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(rohses, deviceData.rohsId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="rohses"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.rohsId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="Tray/Tube Strapping" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(trayTubeStrappings, deviceData.trayTubeStrappingId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="trayTubeStrappings"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.trayTubeStrappingId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
        
        <kendo-label text="TrayStacking" class="k-font-size-sm">
          <input *ngIf="isViewMode" kendoTextBox [value]="getDropdownDisplayText(trayStackings, deviceData.trayStackingId)" type="text"
            class="w-100" readonly />
          <kendo-dropdownlist
            *ngIf="!isViewMode"
            [data]="trayStackings"
            [valuePrimitive]="true"
            [textField]="'name'"
            [valueField]="'id'"
            [(ngModel)]="deviceData.trayStackingId"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            [defaultItem]="{ id: -1, name: '--Select--' }"
            class="w-100">
          </kendo-dropdownlist>
        </kendo-label>
      </div>
    </div>
    
    <!-- Devices in Use link (shown when canEdit is false, matching TFS line 117 - Grid.Row="8") -->
    <div *ngIf="!canEdit && isEditMode" class="k-d-flex k-align-items-center k-mt-2" style="width: 100%;">
      <a href="javascript:void(0)" (click)="openDeviceInfoDialog(); $event.preventDefault()" 
         style="color: #ff6b6b; font-weight: bold; text-decoration: none; cursor: pointer; margin-left: 5px;">Devices in Use</a>
    </div>
    
    <div class="k-d-flex k-justify-content-end k-gap-2 k-mt-2" *ngIf="!isViewMode">
      <button kendoButton (click)="closeDialog()">Cancel</button>
      <button kendoButton themeColor="primary" (click)="saveDevice()">Save</button>
    </div>
    <div class="k-d-flex k-justify-content-end k-gap-2 k-mt-2" *ngIf="isViewMode">
      <button kendoButton (click)="closeDialog()">Close</button>
    </div>
  </div>
</kendo-dialog>

<!-- Label Details Dialog -->
<kendo-dialog
  *ngIf="isLabelDetailsDialogOpen"
  (close)="closeLabelDetailsDialog()"
  [width]="558"
  [minWidth]="558"
  [maxWidth]="558"
  class="dialog-round label-details-dialog">
  <div class="k-d-flex k-align-items-center k-mb-2">
    <h2 class="k-m-0 k-font-size-lg">Label Details</h2>
    <button kendoButton type="button" rounded="full" class="k-ml-auto" [svgIcon]="ICON.xIcon" size="small"
      (click)="closeLabelDetailsDialog()"></button>
  </div>
  <div class="k-d-flex k-flex-column k-gap-2 k-p-2">
    <div class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <!-- Label Name Display (shows which label combo box triggered the dialog) -->
      <div class="label-details-name-row">
        <span class="label-details-name-label">Label{{ currentLabelNumber > 0 ? currentLabelNumber : '' }} :</span>
        <div class="label-details-name-value">{{ currentLabelName }}</div>
      </div>
    
      <kendo-grid
        [data]="labelDetailsData"
        [scrollable]="'none'"
        [style.height.px]="labelDetailsGridHeight"
        style="width: 100%;"
        class="compact-label-grid">
      <kendo-grid-column field="lfName" title="Name" [width]="150" [locked]="false">
        <ng-template kendoGridCellTemplate let-dataItem>
          <div style="font-size: 11px; font-family: Verdana; padding: 2px 4px; height: 20px; line-height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" [title]="dataItem.lfName">
            {{ dataItem.lfName }}
          </div>
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="ldType" title="Type" [width]="150" [locked]="false">
        <ng-template kendoGridCellTemplate let-dataItem>
          <div style="padding: 0;">
            <kendo-dropdownlist
              *ngIf="dataItem.ldTypecmbvisibility === 'Visible' && !isViewMode"
              [data]="labelTypeOptions"
              [(ngModel)]="dataItem.ldType"
              (valueChange)="onLabelTypeChange(dataItem, $event)"
              [disabled]="!dataItem.isEnable"
              [filterable]="true"
              [kendoDropDownFilter]="filterSettings"
              style="width: 100%; font-size: 11px; height: 20px; border: none;">
            </kendo-dropdownlist>
            <div *ngIf="dataItem.ldTypecmbvisibility === 'Visible' && isViewMode" 
                 style="font-size: 11px; font-family: Verdana; padding: 2px 4px; height: 20px; line-height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                 [title]="dataItem.ldType">
              {{ dataItem.ldType }}
            </div>
            <kendo-dropdownlist
              *ngIf="dataItem.imgcmbvisibility === 'Visible' && !isViewMode"
              [data]="dataItem.packAndLabelImagesList || ['--Select--', 'Image1', 'Image2', 'Image3']"
              [(ngModel)]="dataItem.imageVisible"
              [disabled]="!dataItem.isEnable || dataItem.isEdit"
              [filterable]="true"
              [kendoDropDownFilter]="filterSettings"
              style="width: 100%; font-size: 11px; height: 20px; border: none;">
            </kendo-dropdownlist>
            <div *ngIf="dataItem.imgcmbvisibility === 'Visible' && isViewMode" 
                 style="font-size: 11px; font-family: Verdana; padding: 2px 4px; height: 20px; line-height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                 [title]="dataItem.imageVisible">
              {{ dataItem.imageVisible }}
            </div>
          </div>
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="ldText" title="Value" [width]="150" [locked]="false">
        <ng-template kendoGridCellTemplate let-dataItem>
          <div style="padding: 0;">
            <input
              *ngIf="dataItem.txtvisibility === 'Visible'"
              kendoTextBox
              [(ngModel)]="dataItem.ldText"
              [readonly]="dataItem.isEdit || isViewMode"
              [disabled]="!dataItem.isEnable || isViewMode"
              style="width: 100%; font-size: 11px; height: 20px; padding: 2px 4px; border: 1px solid #ccc;" />
          <kendo-dropdownlist
            *ngIf="dataItem.cmbvisibility === 'Visible' && !isViewMode"
            [data]="dataItem.ldValuesList && dataItem.ldValuesList.length > 0 ? dataItem.ldValuesList : labelValueOptions"
            [(ngModel)]="dataItem.ldValue"
            [disabled]="!dataItem.isEnable"
            [filterable]="true"
            [kendoDropDownFilter]="filterSettings"
            style="width: 100%; font-size: 11px; height: 20px; border: none;">
          </kendo-dropdownlist>
          <div *ngIf="dataItem.cmbvisibility === 'Visible' && isViewMode" 
               style="font-size: 11px; font-family: Verdana; padding: 2px 4px; height: 20px; line-height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
               [title]="dataItem.ldValue">
            {{ dataItem.ldValue }}
          </div>
          </div>
        </ng-template>
      </kendo-grid-column>
    </kendo-grid>
    </div>
    
    <div class="k-d-flex k-justify-content-end k-gap-2 k-mt-3">
      <button kendoButton themeColor="primary" *ngIf="!isViewMode" (click)="saveLabelDetails()" style="min-width: 85px; height: 25px; font-size: 11px;">OK</button>
      <button kendoButton (click)="closeLabelDetailsDialog()" style="min-width: 85px; height: 25px; font-size: 11px;">{{ isViewMode ? 'Close' : 'Cancel' }}</button>
    </div>
  </div>
</kendo-dialog>

<!-- Device Info Dialog (Devices in Use) -->
<kendo-dialog
  *ngIf="isDeviceInfoDialogOpen"
  (close)="closeDeviceInfoDialog()"
  [width]="'95%'"
  [minWidth]="1200"
  [height]="'95%'"
  class="dialog-round device-info-dialog">
  <div class="k-d-flex k-align-items-center k-mb-2">
    <h2 class="k-m-0 k-font-size-lg">Devices in Use</h2>
    <button kendoButton type="button" rounded="full" class="k-ml-auto" [svgIcon]="ICON.xIcon" size="small"
      (click)="closeDeviceInfoDialog()"></button>
  </div>
  <div class="k-d-flex k-flex-column k-gap-2 k-p-2 dialog-scrollable-content" style="max-height: calc(95vh - 120px); overflow-y: auto;">
    
    <!-- DQP Section -->
    <div *ngIf="deviceInfoData.dqp && deviceInfoData.dqp.length > 0" class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">DQP</h3>
      <kendo-grid
        [data]="deviceInfoData.dqp"
        [pageSize]="10"
        [pageable]="true"
        [sortable]="true"
        [resizable]="true"
        style="height: 300px;">
        <kendo-grid-column *ngFor="let col of getGridColumns(deviceInfoData.dqp)" [field]="col.field" [title]="col.title" [width]="col.width">
        </kendo-grid-column>
      </kendo-grid>
    </div>
    
    <!-- Master Flow Section -->
    <div *ngIf="deviceInfoData.mf && deviceInfoData.mf.length > 0" class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">Master Flow</h3>
      <kendo-grid
        [data]="deviceInfoData.mf"
        [pageSize]="10"
        [pageable]="true"
        [sortable]="true"
        [resizable]="true"
        style="height: 300px;">
        <kendo-grid-column *ngFor="let col of getGridColumns(deviceInfoData.mf)" [field]="col.field" [title]="col.title" [width]="col.width">
        </kendo-grid-column>
      </kendo-grid>
    </div>
    
    <!-- Traveler Section -->
    <div *ngIf="deviceInfoData.trv && deviceInfoData.trv.length > 0" class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">Traveler</h3>
      <kendo-grid
        [data]="deviceInfoData.trv"
        [pageSize]="10"
        [pageable]="true"
        [sortable]="true"
        [resizable]="true"
        style="height: 300px;">
        <kendo-grid-column *ngFor="let col of getGridColumns(deviceInfoData.trv)" [field]="col.field" [title]="col.title" [width]="col.width">
        </kendo-grid-column>
      </kendo-grid>
    </div>
    
    <!-- Boards Section -->
    <div *ngIf="deviceInfoData.boards && deviceInfoData.boards.length > 0" class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">Boards</h3>
      <kendo-grid
        [data]="deviceInfoData.boards"
        [pageSize]="10"
        [pageable]="true"
        [sortable]="true"
        [resizable]="true"
        style="height: 300px;">
        <kendo-grid-column *ngFor="let col of getGridColumns(deviceInfoData.boards)" [field]="col.field" [title]="col.title" [width]="col.width">
        </kendo-grid-column>
      </kendo-grid>
    </div>
    
    <!-- Device Label Info Section -->
    <div *ngIf="deviceInfoData.deviceLabelInfo && deviceInfoData.deviceLabelInfo.length > 0" class="k-border k-border-solid k-border-gray-300 k-p-3 k-rounded">
      <h3 class="k-mt-0 k-mb-2 k-text-primary k-font-size-md">Device Label Info</h3>
      <kendo-grid
        [data]="deviceInfoData.deviceLabelInfo"
        [pageSize]="10"
        [pageable]="true"
        [sortable]="true"
        [resizable]="true"
        style="height: 300px;">
        <kendo-grid-column *ngFor="let col of getGridColumns(deviceInfoData.deviceLabelInfo)" [field]="col.field" [title]="col.title" [width]="col.width">
        </kendo-grid-column>
      </kendo-grid>
    </div>
    
    <div class="k-d-flex k-justify-content-end k-gap-2 k-mt-2">
      <button kendoButton (click)="closeDeviceInfoDialog()">Close</button>
    </div>
  </div>
</kendo-dialog>
